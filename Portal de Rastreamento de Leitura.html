<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Rastreamento de Leitura</title>
    <style>
        :root {
            --color-primary: #2180a0;
            --color-primary-hover: #1a6a7f;
            --color-success: #22c55e;
            --color-error: #ef4444;
            --color-warning: #f59e0b;
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-border: #e5e7eb;
            --color-text: #1f2937;
            --color-text-secondary: #6b7280;
            --radius: 8px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--color-primary);
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-btn:hover {
            color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background-color: var(--color-surface);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="file"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 160, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-danger {
            background-color: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--color-surface);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        thead {
            background-color: #f3f4f6;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
            border-bottom: 2px solid var(--color-border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: #b45309;
        }

        .status-completed {
            background-color: rgba(34, 197, 94, 0.1);
            color: #15803d;
        }

        .status-read {
            background-color: rgba(34, 197, 94, 0.1);
            color: #15803d;
        }

        .status-not-read {
            background-color: rgba(239, 68, 68, 0.1);
            color: #7f1d1d;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--color-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--color-success);
            transition: width 0.3s ease;
        }

        .stat-card {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            color: #15803d;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #7f1d1d;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--color-surface);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--color-primary);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üìã Portal de Rastreamento de Leitura</h1>
            <p class="subtitle">Gest√£o de documentos e confirma√ß√£o de leitura offline</p>
        </div>
    </header>

    <div class="container">
        <!-- Mensagens de Alerta -->
        <div id="alertContainer"></div>

        <!-- Abas de Navega√ß√£o -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('documents')">üìÑ Documentos</button>
            <button class="tab-btn" onclick="switchTab('users')">üë• Colaboradores</button>
            <button class="tab-btn" onclick="switchTab('assignments')">üì§ Atribui√ß√µes</button>
            <button class="tab-btn" onclick="switchTab('sharing')">üîó Compartilhamento</button>
            <button class="tab-btn" onclick="switchTab('statistics')">üìä Estat√≠sticas</button>
            <button class="tab-btn" onclick="switchTab('backup')">üíæ Backup</button>
        </div>

        <!-- ABA: DOCUMENTOS -->
        <div id="documents" class="tab-content active">
            <div class="form-section">
                <h2>Adicionar Novo Documento</h2>
                <form onsubmit="addDocument(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="docName">Nome do Documento</label>
                            <input type="text" id="docName" required placeholder="Ex: Pol√≠tica de Seguran√ßa">
                        </div>
                        <div class="form-group">
                            <label for="docVersion">Vers√£o</label>
                            <input type="text" id="docVersion" placeholder="Ex: 1.0" value="1.0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="docDescription">Descri√ß√£o</label>
                        <textarea id="docDescription" placeholder="Descri√ß√£o do documento..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="docFile">Upload do PDF</label>
                        <input type="file" id="docFile" accept=".pdf" required>
                        <small style="color: var(--color-text-secondary); margin-top: 5px; display: block;">
                            ‚ö†Ô∏è O arquivo ser√° armazenado localmente. M√°x: 50MB
                        </small>
                    </div>
                    <button type="submit" class="button btn-primary">Adicionar Documento</button>
                </form>
            </div>

            <div class="form-section">
                <h2>Documentos Cadastrados</h2>
                <div id="documentsList"></div>
            </div>
        </div>

        <!-- ABA: COLABORADORES -->
        <div id="users" class="tab-content">
            <div class="form-section">
                <h2>Adicionar Colaborador</h2>
                <form onsubmit="addUser(event)">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="userName">Nome Completo</label>
                            <input type="text" id="userName" required placeholder="Ex: Jo√£o Silva">
                        </div>
                        <div class="form-group">
                            <label for="userEmail">Email</label>
                            <input type="email" id="userEmail" required placeholder="joao@empresa.com">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="userDept">Departamento</label>
                            <input type="text" id="userDept" placeholder="Ex: TI, RH, Vendas">
                        </div>
                        <div class="form-group">
                            <label for="userRole">Cargo</label>
                            <input type="text" id="userRole" placeholder="Ex: Analista, Gerente">
                        </div>
                    </div>
                    <button type="submit" class="button btn-primary">Adicionar Colaborador</button>
                </form>
            </div>

            <div class="form-section">
                <h2>Colaboradores Cadastrados</h2>
                <div id="usersList"></div>
            </div>
        </div>

        <!-- ABA: ATRIBUI√á√ïES -->
        <div id="assignments" class="tab-content">
            <div class="form-section">
                <h2>Atribuir Documentos</h2>
                <form onsubmit="createAssignment(event)">
                    <div class="form-group">
                        <label for="assignDocument">Selecione o Documento</label>
                        <select id="assignDocument" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px;">
                            <option value="">-- Escolha um documento --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Selecione os Colaboradores</span>
                            <button type="button" class="button btn-small btn-secondary" onclick="selectAllUsers()" style="margin: 0;">‚úì Selecionar Todos</button>
                        </label>
                        <div id="userCheckboxes" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border); padding: 12px; border-radius: 6px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="assignDeadline">Prazo para Leitura</label>
                        <input type="date" id="assignDeadline" required>
                    </div>
                    <button type="submit" class="button btn-primary">Atribuir a Selecionados</button>
                </form>
            </div>

            <div class="form-section">
                <h2>Status de Atribui√ß√µes</h2>
                <div id="assignmentsList"></div>
            </div>
        </div>

        <!-- ABA: COMPARTILHAMENTO -->
        <div id="sharing" class="tab-content">
            <div class="form-section">
                <h2>üîó Gerar Links de Compartilhamento</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                    Gere links √∫nicos e seguros para compartilhar documentos com colaboradores. Cada link √© espec√≠fico para um documento e colaborador.
                </p>
                
                <div class="form-group">
                    <label for="shareAssignment">Selecione uma Atribui√ß√£o</label>
                    <select id="shareAssignment" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 14px; margin-bottom: 15px;">
                        <option value="">-- Escolha uma atribui√ß√£o --</option>
                    </select>
                </div>

                <div id="sharingLinks" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px; color: var(--color-primary);">Links Gerados</h3>
                    <div id="linksContainer"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>üìß Instru√ß√µes para Email</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 15px;">
                    Copie e cole este modelo de email para enviar aos colaboradores:
                </p>
                <textarea id="emailTemplate" readonly style="width: 100%; padding: 15px; border: 1px solid var(--color-border); border-radius: 6px; font-family: monospace; font-size: 13px; background-color: #f3f4f6; color: #1f2937; min-height: 200px;"></textarea>
                <button class="button btn-primary" onclick="copyEmailTemplate()" style="margin-top: 10px;">üìã Copiar Modelo de Email</button>
            </div>

            <div class="form-section">
                <h2>üìä Status de Compartilhamentos</h2>
                <div id="sharingStatus"></div>
            </div>
        </div>

        <!-- ABA: ESTAT√çSTICAS -->
        <div id="statistics" class="tab-content">
            <div id="statsContainer"></div>
        </div>

        <!-- ABA: BACKUP E DADOS -->
        <div id="backup" class="tab-content">
            <div class="form-section">
                <h2>üîí Gerenciar Backups e Dados</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                    Exporte seus dados em Excel ou JSON para criar backups seguros. Importe dados de backups anteriores para recuperar informa√ß√µes.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="border: 1px solid var(--color-border); padding: 15px; border-radius: var(--radius); background-color: #fafafa;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--color-primary);">üìä Exportar para Excel</h3>
                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--color-text-secondary);">
                            Cria um arquivo .xlsx com todas as abas: Documentos, Colaboradores, Atribui√ß√µes, Leituras e Resumo.
                        </p>
                        <button class="button btn-primary" onclick="exportToExcel()" style="width: 100%;">Exportar para Excel</button>
                    </div>

                    <div style="border: 1px solid var(--color-border); padding: 15px; border-radius: var(--radius); background-color: #fafafa;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--color-primary);">üíæ Exportar para JSON</h3>
                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--color-text-secondary);">
                            Cria um arquivo .json com todos os dados. Ideal para backups e migra√ß√µes entre m√°quinas.
                        </p>
                        <button class="button btn-primary" onclick="exportToJSON()" style="width: 100%;">Exportar para JSON</button>
                    </div>

                    <div style="border: 1px solid var(--color-border); padding: 15px; border-radius: var(--radius); background-color: #fafafa;">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px; color: var(--color-primary);">üìÇ Importar Dados</h3>
                        <p style="margin: 0 0 15px 0; font-size: 13px; color: var(--color-text-secondary);">
                            Restaure dados de um backup JSON anterior. Substitui os dados atuais do portal.
                        </p>
                        <label class="button btn-primary" style="width: 100%; cursor: pointer; display: inline-block;">
                            Importar JSON
                            <input type="file" accept=".json" onchange="importFromJSON(event)" style="display: none;">
                        </label>
                    </div>
                </div>

                <div style="background-color: rgba(245, 158, 11, 0.1); border-left: 4px solid var(--color-warning); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong style="color: #b45309;">üí° Dica:</strong>
                    <p style="margin: 8px 0 0 0; color: #92400e; font-size: 13px;">
                        Recomendamos exportar seus dados regularmente (semanal ou mensal) para criar backups de seguran√ßa. 
                        Os dados s√£o armazenados localmente no seu navegador, mas √© importante manter c√≥pias externas.
                    </p>
                </div>
            </div>

            <div class="form-section">
                <h2>üìã Informa√ß√µes do Armazenamento Local</h2>
                <div id="storageInfo"></div>
            </div>

            <div class="form-section">
                <h2 style="color: var(--color-error);">‚ö†Ô∏è Opera√ß√µes Perigosas</h2>
                <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                    Estas a√ß√µes s√£o irrevers√≠veis. Use com cuidado!
                </p>
                <button class="button btn-danger" onclick="clearAllData()" style="width: 100%; margin-bottom: 10px;">
                    üóëÔ∏è Limpar TODOS os Dados (Irrevers√≠vel)
                </button>
                <p style="font-size: 12px; color: var(--color-text-secondary);">
                    Esta a√ß√£o vai apagar permanentemente todos os documentos, colaboradores, atribui√ß√µes e leituras do portal.
                </p>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Documento -->
    <div id="docModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Confirmar Leitura do Documento</div>
            <p id="docTitle" style="font-size: 16px; margin-bottom: 15px;"></p>
            <div id="pdfContainer" style="width: 100%; height: 500px; border: 1px solid var(--color-border); border-radius: 6px; overflow: auto; margin-bottom: 15px; background-color: #f3f4f6;"></div>
            <p id="pdfStatus" style="text-align: center; color: var(--color-text-secondary); font-size: 14px;"></p>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="confirmReadCheckbox" style="width: auto; margin-right: 8px;">
                    Confirmo que li o documento at√© o final
                </label>
            </div>
            <div class="modal-buttons">
                <button class="button btn-secondary" onclick="closeDocModal()">Fechar</button>
                <button class="button btn-primary" id="confirmReadBtn" onclick="confirmRead()" disabled>Confirmar Leitura</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ESTRUTURA DE DADOS LOCAL =====
        let data = {
            documents: [],
            users: [],
            assignments: [],
            readings: []
        };

        // Carrega dados do localStorage ao iniciar
        function loadData() {
            const saved = localStorage.getItem('portalData');
            if (saved) {
                data = JSON.parse(saved);
            }
        }

        // Salva dados no localStorage
        function saveData() {
            localStorage.setItem('portalData', JSON.stringify(data));
        }

        // ===== GERENCIAMENTO DE ABAS =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'statistics') {
                loadStatistics();
            } else if (tabName === 'assignments') {
                loadAssignments();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'documents') {
                loadDocuments();
            } else if (tabName === 'sharing') {
                loadSharingTab();
            } else if (tabName === 'backup') {
                loadBackupInfo();
            }
        }

        function loadBackupInfo() {
            const storageInfo = document.getElementById('storageInfo');
            const localStorageSize = new Blob(Object.values(localStorage)).size;
            const localStorageSizeMB = (localStorageSize / 1024 / 1024).toFixed(2);

            let html = `
                <table style="width: 100%; margin-bottom: 20px;">
                    <tr style="background-color: #f3f4f6;">
                        <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid var(--color-border);">M√©trica</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border);">Valor</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--color-border);">Total de Documentos</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border); color: var(--color-primary); font-weight: 600;">${data.documents.length}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--color-border);">Total de Colaboradores</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border); color: var(--color-primary); font-weight: 600;">${data.users.length}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--color-border);">Total de Atribui√ß√µes</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border); color: var(--color-primary); font-weight: 600;">${data.assignments.length}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--color-border);">Leituras Confirmadas</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border); color: var(--color-primary); font-weight: 600;">${data.readings.length}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid var(--color-border);">Tamanho do Armazenamento Local</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--color-border); color: var(--color-primary); font-weight: 600;">${localStorageSizeMB} MB</td>
                    </tr>
                    <tr style="background-color: #f3f4f6;">
                        <td style="padding: 12px; font-weight: 600;">√öltima Atualiza√ß√£o</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${new Date().toLocaleString('pt-BR')}</td>
                    </tr>
                </table>

                <div style="background-color: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--color-success); padding: 15px; border-radius: 6px;">
                    <strong style="color: #15803d;">‚úÖ Status:</strong>
                    <p style="margin: 8px 0 0 0; color: #166534; font-size: 13px;">
                        Seus dados est√£o sendo armazenados com seguran√ßa no localStorage do seu navegador. 
                        Todos os arquivos, datas e hist√≥ricos ser√£o mantidos mesmo ap√≥s fechar o navegador.
                    </p>
                </div>
            `;

            storageInfo.innerHTML = html;
        }

        // ===== ALERTAS =====
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // ===== DOCUMENTOS =====
        function addDocument(event) {
            event.preventDefault();
            const name = document.getElementById('docName').value;
            const version = document.getElementById('docVersion').value;
            const description = document.getElementById('docDescription').value;
            const file = document.getElementById('docFile').files[0];

            if (!file) {
                showAlert('Por favor, selecione um arquivo PDF', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const doc = {
                    id: Date.now(),
                    name: name,
                    version: version,
                    description: description,
                    file: e.target.result,
                    fileName: file.name,
                    createdAt: new Date().toLocaleDateString('pt-BR'),
                    pages: estimatePages(file.size)
                };
                data.documents.push(doc);
                saveData();
                showAlert(`Documento "${name}" adicionado com sucesso!`);
                event.target.reset();
                loadDocuments();
            };
            reader.readAsArrayBuffer(file);
        }

        function estimatePages(fileSize) {
            return Math.ceil(fileSize / 5000);
        }

        function loadDocuments() {
            const list = document.getElementById('documentsList');
            if (data.documents.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nenhum documento cadastrado</p></div>';
                return;
            }

            list.innerHTML = data.documents.map(doc => `
                <div style="padding: 15px; border: 1px solid var(--color-border); border-radius: 6px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: var(--color-primary);">${doc.name}</h3>
                            <p style="margin: 0; font-size: 12px; color: var(--color-text-secondary);">
                                Vers√£o ${doc.version} ‚Ä¢ ${doc.pages} p√°ginas ‚Ä¢ Adicionado em ${doc.createdAt}
                            </p>
                            <p style="margin: 5px 0 0 0; font-size: 13px;">${doc.description}</p>
                        </div>
                        <div class="action-buttons">
                            <button class="button btn-small btn-secondary" onclick="previewDocument(${doc.id})">Visualizar</button>
                            <button class="button btn-small btn-danger" onclick="deleteDocument(${doc.id})">Remover</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteDocument(id) {
            if (confirm('Tem certeza que deseja remover este documento?')) {
                data.documents = data.documents.filter(d => d.id !== id);
                data.assignments = data.assignments.filter(a => a.documentId !== id);
                saveData();
                showAlert('Documento removido com sucesso!');
                loadDocuments();
            }
        }

        function previewDocument(id) {
            const doc = data.documents.find(d => d.id === id);
            if (!doc) return;
            
            document.getElementById('docTitle').textContent = doc.name;
            document.getElementById('pdfStatus').textContent = 'Documento carregado. Role at√© o final para confirmar a leitura.';
            const pdfContainer = document.getElementById('pdfContainer');
            
            if (doc.file) {
                try {
                    const blob = new Blob([doc.file], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    pdfContainer.innerHTML = `<iframe src="${url}" style="width: 100%; height: 100%; border: none; border-radius: 6px; background: white;"></iframe>`;
                } catch (error) {
                    pdfContainer.innerHTML = `
                        <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
                            <h2>${doc.name} (v${doc.version})</h2>
                            <p style="color: #666; font-size: 12px;">Total de p√°ginas: ${doc.pages}</p>
                            <p style="margin-top: 20px; line-height: 1.8; color: #333;">
                                <strong>Descri√ß√£o do Documento:</strong><br>
                                ${doc.description || 'Sem descri√ß√£o'}<br><br>
                                Este √© um documento importante que deve ser lido at√© o final. 
                                Ap√≥s confirmar a leitura completa, seus logs ser√£o registrados no sistema.
                            </p>
                        </div>
                    `;
                }
            }

            document.getElementById('confirmReadCheckbox').checked = false;
            document.getElementById('docModal').classList.add('active');
            document.getElementById('docModal').dataset.docId = id;
        }

        function closeDocModal() {
            document.getElementById('docModal').classList.remove('active');
            document.getElementById('confirmReadCheckbox').checked = false;
        }

        document.getElementById('confirmReadCheckbox')?.addEventListener('change', function() {
            document.getElementById('confirmReadBtn').disabled = !this.checked;
        });

        function confirmRead() {
            const docId = parseInt(document.getElementById('docModal').dataset.docId);
            const isCollaboratorMode = document.getElementById('docModal').dataset.collaboratorMode === 'true';
            
            if (isCollaboratorMode) {
                confirmReadCollaborator();
            } else {
                const doc = data.documents.find(d => d.id === docId);
                if (!doc) return;

                const reading = {
                    id: Date.now(),
                    documentId: docId,
                    documentName: doc.name,
                    readAt: new Date().toLocaleString('pt-BR'),
                    timestamp: Date.now()
                };
                data.readings.push(reading);
                saveData();
                showAlert(`Leitura de "${doc.name}" confirmada com sucesso!`);
                closeDocModal();
                loadDocuments();
            }
        }

        // ===== COLABORADORES =====
        function addUser(event) {
            event.preventDefault();
            const user = {
                id: Date.now(),
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                department: document.getElementById('userDept').value,
                role: document.getElementById('userRole').value,
                createdAt: new Date().toLocaleDateString('pt-BR')
            };
            data.users.push(user);
            saveData();
            showAlert(`Colaborador "${user.name}" adicionado com sucesso!`);
            event.target.reset();
            loadUsers();
            updateUserCheckboxes();
        }

        function loadUsers() {
            const list = document.getElementById('usersList');
            if (data.users.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Nenhum colaborador cadastrado</p></div>';
                return;
            }

            list.innerHTML = '<table><thead><tr><th>Nome</th><th>Email</th><th>Departamento</th><th>Cargo</th><th>A√ß√µes</th></tr></thead><tbody>' + 
            data.users.map(user => `
                <tr>
                    <td><strong>${user.name}</strong></td>
                    <td>${user.email}</td>
                    <td>${user.department || '-'}</td>
                    <td>${user.role || '-'}</td>
                    <td><button class="button btn-small btn-danger" onclick="deleteUser(${user.id})">Remover</button></td>
                </tr>
            `).join('') + '</tbody></table>';
        }

        function deleteUser(id) {
            if (confirm('Tem certeza?')) {
                data.users = data.users.filter(u => u.id !== id);
                data.assignments = data.assignments.filter(a => !a.userIds.includes(id));
                saveData();
                showAlert('Colaborador removido!');
                loadUsers();
            }
        }

        function updateUserCheckboxes() {
            const checkboxes = document.getElementById('userCheckboxes');
            if (data.users.length === 0) {
                checkboxes.innerHTML = '<p style="color: var(--color-text-secondary);">Nenhum colaborador cadastrado</p>';
                return;
            }
            checkboxes.innerHTML = data.users.map(user => `
                <label style="display: block; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" value="${user.id}" class="userCheckbox" style="margin-right: 8px;">
                    ${user.name} (${user.email})
                </label>
            `).join('');
        }

        function selectAllUsers() {
            const checkboxes = document.querySelectorAll('.userCheckbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }

        // ===== ATRIBUI√á√ïES =====
        function createAssignment(event) {
            event.preventDefault();
            const docId = parseInt(document.getElementById('assignDocument').value);
            const deadline = document.getElementById('assignDeadline').value;
            const selectedUsers = Array.from(document.querySelectorAll('#userCheckboxes input:checked')).map(cb => parseInt(cb.value));

            if (selectedUsers.length === 0) {
                showAlert('Selecione pelo menos um colaborador', 'error');
                return;
            }

            const assignment = {
                id: Date.now(),
                documentId: docId,
                userIds: selectedUsers,
                deadline: deadline,
                createdAt: new Date().toLocaleDateString('pt-BR'),
                completed: false
            };
            data.assignments.push(assignment);
            saveData();
            showAlert(`Documento atribu√≠do a ${selectedUsers.length} colaborador(es)`);
            event.target.reset();
            updateUserCheckboxes();
            loadAssignments();
        }

        function loadAssignments() {
            const list = document.getElementById('assignmentsList');
            updateDocumentSelect();
            updateUserCheckboxes();

            if (data.assignments.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nenhuma atribui√ß√£o feita</p></div>';
                return;
            }

            list.innerHTML = '<table><thead><tr><th>Documento</th><th>Colaboradores</th><th>Prazo</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>' + 
            data.assignments.map(assign => {
                const doc = data.documents.find(d => d.id === assign.documentId);
                const users = assign.userIds.map(uid => data.users.find(u => u.id === uid)?.name).filter(Boolean);
                return `
                    <tr>
                        <td>${doc?.name || 'Documento removido'}</td>
                        <td>${users.join(', ')}</td>
                        <td>${new Date(assign.deadline).toLocaleDateString('pt-BR')}</td>
                        <td><span class="status-badge status-pending">Pendente</span></td>
                        <td><button class="button btn-small btn-danger" onclick="deleteAssignment(${assign.id})">Remover</button></td>
                    </tr>
                `;
            }).join('') + '</tbody></table>';
        }

        function deleteAssignment(id) {
            if (confirm('Remover esta atribui√ß√£o?')) {
                data.assignments = data.assignments.filter(a => a.id !== id);
                saveData();
                showAlert('Atribui√ß√£o removida!');
                loadAssignments();
            }
        }

        function updateDocumentSelect() {
            const select = document.getElementById('assignDocument');
            select.innerHTML = '<option value="">-- Escolha um documento --</option>' + 
            data.documents.map(doc => `<option value="${doc.id}">${doc.name}</option>`).join('');
        }

        // ===== ESTAT√çSTICAS =====
        function loadStatistics() {
            const stats = document.getElementById('statsContainer');
            
            const totalDocs = data.documents.length;
            const totalUsers = data.users.length;
            const totalAssignments = data.assignments.length;
            const totalReadings = data.readings.length;
            const readingPercentage = totalAssignments > 0 ? Math.round((totalReadings / totalAssignments) * 100) : 0;

            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalDocs}</div>
                        <div class="stat-label">Documentos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalUsers}</div>
                        <div class="stat-label">Colaboradores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalAssignments}</div>
                        <div class="stat-label">Atribui√ß√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${readingPercentage}%</div>
                        <div class="stat-label">Leituras Confirmadas</div>
                    </div>
                </div>

                <div class="form-section">
                    <h2>Taxa de Leitura por Documento</h2>
            `;

            if (data.documents.length === 0) {
                html += '<p style="color: var(--color-text-secondary);">Nenhum documento cadastrado</p>';
            } else {
                data.documents.forEach(doc => {
                    const docReadings = data.readings.filter(r => r.documentId === doc.id).length;
                    const docAssignments = data.assignments.filter(a => a.documentId === doc.id).length;
                    const percentage = docAssignments > 0 ? Math.round((docReadings / docAssignments) * 100) : 0;

                    html += `
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span><strong>${doc.name}</strong></span>
                                <span style="color: var(--color-primary); font-weight: 600;">${docReadings}/${docAssignments} (${percentage}%)</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                </div>

                <div class="form-section">
                    <h2>√öltimas Leituras Confirmadas</h2>
            `;

            if (data.readings.length === 0) {
                html += '<p style="color: var(--color-text-secondary);">Nenhuma leitura registrada</p>';
            } else {
                html += '<table><thead><tr><th>Documento</th><th>Data/Hora</th></tr></thead><tbody>' + 
                data.readings.slice(-10).reverse().map(reading => `
                    <tr>
                        <td>${reading.documentName}</td>
                        <td>${reading.readAt}</td>
                    </tr>
                `).join('') + '</tbody></table>';
            }

            html += '</div>';
            stats.innerHTML = html;
        }

        // ===== EXPORTA√á√ÉO E IMPORTA√á√ÉO DE DADOS =====
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            const docsData = data.documents.map(doc => ({
                'ID': doc.id,
                'Nome': doc.name,
                'Vers√£o': doc.version,
                'Descri√ß√£o': doc.description,
                'P√°ginas': doc.pages,
                'Adicionado em': doc.createdAt
            }));
            const docsSheet = XLSX.utils.json_to_sheet(docsData);
            XLSX.utils.book_append_sheet(wb, docsSheet, 'Documentos');
            
            const usersData = data.users.map(user => ({
                'ID': user.id,
                'Nome': user.name,
                'Email': user.email,
                'Departamento': user.department,
                'Cargo': user.role,
                'Adicionado em': user.createdAt
            }));
            const usersSheet = XLSX.utils.json_to_sheet(usersData);
            XLSX.utils.book_append_sheet(wb, usersSheet, 'Colaboradores');
            
            const assignData = data.assignments.map(assign => {
                const doc = data.documents.find(d => d.id === assign.documentId);
                const users = assign.userIds.map(uid => data.users.find(u => u.id === uid)?.name).filter(Boolean);
                return {
                    'ID': assign.id,
                    'Documento': doc?.name || 'Removido',
                    'Colaboradores': users.join('; '),
                    'Prazo': new Date(assign.deadline).toLocaleDateString('pt-BR'),
                    'Criado em': assign.createdAt
                };
            });
            const assignSheet = XLSX.utils.json_to_sheet(assignData);
            XLSX.utils.book_append_sheet(wb, assignSheet, 'Atribui√ß√µes');
            
            const readingsData = data.readings.map(reading => ({
                'ID': reading.id,
                'Documento': reading.documentName,
                'Data/Hora': reading.readAt,
                'Timestamp': new Date(reading.timestamp).toLocaleString('pt-BR')
            }));
            const readingsSheet = XLSX.utils.json_to_sheet(readingsData);
            XLSX.utils.book_append_sheet(wb, readingsSheet, 'Leituras');
            
            const summaryData = [
                { 'M√©trica': 'Total de Documentos', 'Valor': data.documents.length },
                { 'M√©trica': 'Total de Colaboradores', 'Valor': data.users.length },
                { 'M√©trica': 'Total de Atribui√ß√µes', 'Valor': data.assignments.length },
                { 'M√©trica': 'Leituras Confirmadas', 'Valor': data.readings.length },
                { 'M√©trica': 'Data de Exporta√ß√£o', 'Valor': new Date().toLocaleString('pt-BR') }
            ];
            const summarySheet = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Resumo');
            
            XLSX.writeFile(wb, `portal_rastreamento_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showAlert('Dados exportados para Excel com sucesso!');
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `portal_rastreamento_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showAlert('Dados exportados para JSON com sucesso!');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.documents && imported.users && imported.assignments && imported.readings) {
                        data = imported;
                        saveData();
                        showAlert('Dados importados com sucesso! Atualizando interface...');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showAlert('Arquivo inv√°lido. Verifique o formato JSON.', 'error');
                    }
                } catch (error) {
                    showAlert('Erro ao importar arquivo: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso vai deletar TODOS os dados do portal. Tem certeza? Esta a√ß√£o N√ÉO pode ser desfeita!')) {
                if (confirm('Voc√™ tem certeza mesmo? Isso √© irrevers√≠vel!')) {
                    data = { documents: [], users: [], assignments: [], readings: [] };
                    localStorage.removeItem('portalData');
                    saveData();
                    showAlert('Todos os dados foram apagados!', 'error');
                    setTimeout(() => location.reload(), 1500);
                }
            }
        }

        // ===== COMPARTILHAMENTO DE LINKS =====
        function loadSharingTab() {
            const select = document.getElementById('shareAssignment');
            select.innerHTML = '<option value="">-- Escolha uma atribui√ß√£o --</option>';
            
            data.assignments.forEach(assign => {
                const doc = data.documents.find(d => d.id === assign.documentId);
                if (doc) {
                    const users = assign.userIds.map(uid => data.users.find(u => u.id === uid)?.name).filter(Boolean);
                    const label = `${doc.name} ‚Üí ${users.join(', ')}`;
                    select.innerHTML += `<option value="${assign.id}">${label}</option>`;
                }
            });

            select.onchange = () => generateSharingLinks(parseInt(select.value));
            loadSharingStatus();
        }

        function generateSharingLinks(assignmentId) {
            if (!assignmentId) {
                document.getElementById('sharingLinks').style.display = 'none';
                return;
            }

            const assignment = data.assignments.find(a => a.id === assignmentId);
            const doc = data.documents.find(d => d.id === assignment.documentId);
            
            let linksHtml = '';
            let emailTemplate = `Assunto: Documento para Leitura Obrigat√≥ria - ${doc.name}\n\n`;
            emailTemplate += `Prezado(a),\n\n`;
            emailTemplate += `Voc√™ recebeu um novo documento para leitura obrigat√≥ria.\n\n`;
            emailTemplate += `üìÑ Documento: ${doc.name} (v${doc.version})\n`;
            emailTemplate += `üìÖ Prazo: ${new Date(assignment.deadline).toLocaleDateString('pt-BR')}\n`;
            emailTemplate += `üìÑ P√°ginas: ${doc.pages}\n\n`;
            emailTemplate += `Descri√ß√£o:\n${doc.description}\n\n`;
            emailTemplate += `---\n\n`;

            assignment.userIds.forEach(userId => {
                const user = data.users.find(u => u.id === userId);
                const shareToken = btoa(`${assignmentId}|${userId}`);
                const url = `${window.location.href.split('?')[0]}?share=${shareToken}`;

                linksHtml += `
                    <div style="border: 1px solid var(--color-border); padding: 15px; border-radius: 6px; margin-bottom: 15px; background-color: #fafafa;">
                        <h4 style="margin: 0 0 10px 0; color: var(--color-text);">${user.name} (${user.email})</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" value="${url}" readonly style="flex: 1; padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 6px; font-family: monospace; font-size: 12px; background-color: white;">
                            <button class="button btn-small btn-primary" onclick="copyToClipboard('${url}')">Copiar</button>
                        </div>
                        <small style="color: var(--color-text-secondary); display: block; margin-top: 8px;">
                            Link √∫nico para ${user.name}
                        </small>
                    </div>
                `;

                emailTemplate += `üë§ ${user.name} (${user.email}):\n`;
                emailTemplate += `${url}\n\n`;
            });

            emailTemplate += `---\n\n`;
            emailTemplate += `‚è±Ô∏è Instru√ß√µes:\n`;
            emailTemplate += `1. Clique no link acima\n`;
            emailTemplate += `2. Fa√ßa login com seu email\n`;
            emailTemplate += `3. Leia o documento at√© o final\n`;
            emailTemplate += `4. Confirme a leitura\n\n`;
            emailTemplate += `Qualquer d√∫vida, entre em contato.\n\n`;
            emailTemplate += `Atenciosamente,\nDepartamento de Compliance`;

            document.getElementById('linksContainer').innerHTML = linksHtml;
            document.getElementById('emailTemplate').value = emailTemplate;
            document.getElementById('sharingLinks').style.display = 'block';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showAlert('Link copiado para a √°rea de transfer√™ncia!');
        }

        function copyEmailTemplate() {
            const template = document.getElementById('emailTemplate').value;
            navigator.clipboard.writeText(template);
            showAlert('Modelo de email copiado para a √°rea de transfer√™ncia!');
        }

        function loadSharingStatus() {
            const status = document.getElementById('sharingStatus');
            
            if (data.assignments.length === 0) {
                status.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nenhuma atribui√ß√£o para compartilhar</p></div>';
                return;
            }

            let html = '<table><thead><tr><th>Documento</th><th>Colaborador</th><th>Email</th><th>Prazo</th><th>Status Leitura</th><th>Data Confirma√ß√£o</th></tr></thead><tbody>';

            data.assignments.forEach(assign => {
                const doc = data.documents.find(d => d.id === assign.documentId);
                assign.userIds.forEach(userId => {
                    const user = data.users.find(u => u.id === userId);
                    const reading = data.readings.find(r => r.documentId === assign.documentId && r.userId === userId);
                    const statusBadge = reading ? '<span class="status-badge status-read">‚úì Lido</span>' : '<span class="status-badge status-not-read">‚úó N√£o Lido</span>';
                    const readDate = reading ? reading.readAt : '-';

                    html += `
                        <tr>
                            <td><strong>${doc?.name || 'Removido'}</strong></td>
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${new Date(assign.deadline).toLocaleDateString('pt-BR')}</td>
                            <td>${statusBadge}</td>
                            <td>${readDate}</td>
                        </tr>
                    `;
                });
            });

            html += '</tbody></table>';
            status.innerHTML = html;
        }

        // ===== SISTEMA DE LOGIN PARA COLABORADORES =====
        function showCollaboratorView(assignmentId, userId) {
            const assignment = data.assignments.find(a => a.id === assignmentId);
            const user = data.users.find(u => u.id === userId);
            const doc = data.documents.find(d => d.id === assignment.documentId);

            // Esconde as abas
            document.querySelector('.tabs').style.display = 'none';
            
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="form-section" style="text-align: center; padding: 40px;">
                    <h2 style="color: var(--color-success); margin-bottom: 10px;">‚úì Autentica√ß√£o Bem-Sucedida</h2>
                    <p style="color: var(--color-text-secondary); margin-bottom: 20px;">Ol√°, ${user.name}!</p>
                </div>

                <div class="form-section">
                    <h2>üìÑ Documento para Leitura</h2>
                    <div style="padding: 15px; background-color: #f3f4f6; border-left: 4px solid var(--color-primary); border-radius: 6px; margin-bottom: 20px;">
                        <p style="margin: 0;"><strong>${doc.name}</strong> (v${doc.version})</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--color-text-secondary);">
                            ${doc.pages} p√°ginas ‚Ä¢ Prazo: ${new Date(assignment.deadline).toLocaleDateString('pt-BR')}
                        </p>
                    </div>

                    <button class="button btn-primary" onclick="openCollaboratorDocument(${assignment.documentId})" style="width: 100%; margin-bottom: 15px; padding: 15px;">
                        üìñ Abrir Documento para Leitura
                    </button>

                    <p style="font-size: 13px; color: var(--color-text-secondary); text-align: center;">
                        Clique no bot√£o acima para visualizar o documento. Ap√≥s ler completamente, voc√™ poder√° confirmar a leitura.
                    </p>
                </div>

                <div class="form-section">
                    <h2>‚ÑπÔ∏è Informa√ß√µes</h2>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 10px; font-weight: 600; width: 30%;">Seu Email:</td>
                            <td style="padding: 10px;">${user.email}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--color-border);">
                            <td style="padding: 10px; font-weight: 600;">Departamento:</td>
                            <td style="padding: 10px;">${user.department || '-'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px; font-weight: 600;">Cargo:</td>
                            <td style="padding: 10px;">${user.role || '-'}</td>
                        </tr>
                    </table>
                </div>

                <button class="button btn-secondary" onclick="logoutCollaborator()" style="width: 100%; margin-top: 20px;">
                    üö™ Sair
                </button>
            `;
        }

        function openCollaboratorDocument(docId) {
            const doc = data.documents.find(d => d.id === docId);
            if (!doc) return;

            const collaborator = JSON.parse(localStorage.getItem('collaboratorMode') || '{}');
            
            document.getElementById('docTitle').textContent = doc.name;
            document.getElementById('pdfStatus').textContent = 'Carregando documento...';
            const pdfContainer = document.getElementById('pdfContainer');
            
            // Force reflow to ensure modal will display
            document.getElementById('docModal').offsetHeight;
            
            if (doc.file) {
                try {
                    const pdfjsLib = window['pdfjs-dist/build/pdf'];
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    const uint8Array = new Uint8Array(doc.file);
                    
                    pdfjsLib.getDocument(uint8Array).promise.then(pdf => {
                        pdfContainer.innerHTML = '';
                        document.getElementById('pdfStatus').textContent = 'Documento carregado. Role at√© o final para confirmar a leitura.';
                        
                        // Renderiza a primeira p√°gina
                        pdf.getPage(1).then(page => {
                            const scale = 1.5;
                            const viewport = page.getViewport({ scale: scale });
                            
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            canvas.style.width = '100%';
                            canvas.style.height = 'auto';
                            canvas.style.display = 'block';
                            canvas.style.margin = '0 auto';
                            canvas.style.borderRadius = '6px';
                            canvas.style.background = 'white';
                            
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            page.render(renderContext).promise.then(() => {
                                pdfContainer.appendChild(canvas);
                            });
                        });
                    }).catch(error => {
                        console.error('Erro ao renderizar PDF:', error);
                        document.getElementById('pdfStatus').textContent = 'Erro ao carregar PDF. Mostrando descri√ß√£o do documento.';
                        pdfContainer.innerHTML = `
                            <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
                                <h2>${doc.name} (v${doc.version})</h2>
                                <p style="color: #666; font-size: 12px;">Total de p√°ginas: ${doc.pages}</p>
                                <p style="margin-top: 20px; line-height: 1.8; color: #333;">
                                    <strong>Descri√ß√£o do Documento:</strong><br>
                                    ${doc.description || 'Sem descri√ß√£o'}<br><br>
                                    Este √© um documento importante que voc√™ deve ler at√© o final. 
                                    Ap√≥s confirmar a leitura completa, seus logs ser√£o registrados no sistema.
                                </p>
                            </div>
                        `;
                    });
                } catch (error) {
                    console.error('Erro ao processar PDF:', error);
                    document.getElementById('pdfStatus').textContent = 'Erro ao processar arquivo.';
                    pdfContainer.innerHTML = `
                        <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
                            <h2>${doc.name} (v${doc.version})</h2>
                            <p style="color: #666; font-size: 12px;">Total de p√°ginas: ${doc.pages}</p>
                            <p style="margin-top: 20px; line-height: 1.8; color: #333;">
                                <strong>Descri√ß√£o do Documento:</strong><br>
                                ${doc.description || 'Sem descri√ß√£o'}<br><br>
                                Este √© um documento importante que voc√™ deve ler at√© o final. 
                                Ap√≥s confirmar a leitura completa, seus logs ser√£o registrados no sistema.
                            </p>
                        </div>
                    `;
                }
            } else {
                pdfContainer.innerHTML = `
                    <div style="padding: 20px; background: white; height: 100%; overflow-y: auto;">
                        <h2>${doc.name} (v${doc.version})</h2>
                        <p style="color: #666; font-size: 12px;">Total de p√°ginas: ${doc.pages}</p>
                        <p style="margin-top: 20px; line-height: 1.8; color: #333;">
                            <strong>Descri√ß√£o do Documento:</strong><br>
                            ${doc.description || 'Sem descri√ß√£o'}<br><br>
                            Este √© um documento importante que voc√™ deve ler at√© o final. 
                            Ap√≥s confirmar a leitura completa, seus logs ser√£o registrados no sistema.
                        </p>
                    </div>
                `;
                document.getElementById('pdfStatus').textContent = 'Documento carregado. Role at√© o final para confirmar a leitura.';
            }

            document.getElementById('confirmReadCheckbox').checked = false;
            document.getElementById('docModal').classList.add('active');
            document.getElementById('docModal').dataset.docId = docId;
            document.getElementById('docModal').dataset.collaboratorMode = 'true';
        }

        function confirmReadCollaborator() {
            const docId = parseInt(document.getElementById('docModal').dataset.docId);
            const collaborator = JSON.parse(localStorage.getItem('collaboratorMode') || '{}');
            const doc = data.documents.find(d => d.id === docId);
            
            if (!doc || !collaborator.userId) return;

            const reading = {
                id: Date.now(),
                documentId: docId,
                documentName: doc.name,
                userId: collaborator.userId,
                readAt: new Date().toLocaleString('pt-BR'),
                timestamp: Date.now()
            };
            data.readings.push(reading);
            saveData();
            
            closeDocModal();
            
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="form-section" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úì</div>
                    <h2 style="color: var(--color-success); margin-bottom: 10px;">Leitura Confirmada com Sucesso!</h2>
                    <p style="color: var(--color-text-secondary); margin-bottom: 30px;">
                        Sua confirma√ß√£o de leitura foi registrada em ${new Date().toLocaleString('pt-BR')}
                    </p>
                    <button class="button btn-secondary" onclick="logoutCollaborator()" style="width: 100%; max-width: 300px;">
                        üö™ Sair
                    </button>
                </div>
            `;
        }

        function logoutCollaborator() {
            localStorage.removeItem('collaboratorMode');
            sessionStorage.removeItem('collaboratorView');
            location.reload();
        }

        // ===== INICIALIZA√á√ÉO =====
        loadData();
        
        // Verifica imediatamente se j√° estava em modo colaborador (ap√≥s refresh)
        const savedCollaboratorMode = localStorage.getItem('collaboratorMode');
        if (savedCollaboratorMode) {
            try {
                const collab = JSON.parse(savedCollaboratorMode);
                if (collab.loggedIn) {
                    showCollaboratorView(collab.assignmentId, collab.userId);
                    // Abre o documento automaticamente ap√≥s renderizar
                    setTimeout(() => openCollaboratorDocument(data.assignments.find(a => a.id === collab.assignmentId)?.documentId), 500);
                    // Impede a execu√ß√£o do resto do c√≥digo de inicializa√ß√£o
                    document.addEventListener('DOMContentLoaded', function() {
                        document.querySelector('.tabs').style.display = 'none';
                    });
                }
            } catch (e) {
                localStorage.removeItem('collaboratorMode');
            }
        }
        
        // Se n√£o est√° em modo colaborador, verifica token de compartilhamento
        if (!savedCollaboratorMode) {
            setTimeout(() => {
                const params = new URLSearchParams(window.location.search);
                const shareToken = params.get('share');

                if (shareToken) {
                    try {
                        const decoded = atob(shareToken);
                        const [assignmentId, userId] = decoded.split('|');
                        
                        const assignId = parseInt(assignmentId);
                        const userIdInt = parseInt(userId);
                        
                        const assignment = data.assignments.find(a => a.id === assignId);
                        const user = data.users.find(u => u.id === userIdInt);
                        
                        if (assignment && user && assignment.userIds.includes(userIdInt)) {
                            localStorage.setItem('collaboratorMode', JSON.stringify({
                                assignmentId: assignId,
                                userId: userIdInt,
                                loggedIn: true
                            }));

                            window.history.replaceState({}, document.title, window.location.href.split('?')[0]);
                            
                            showCollaboratorView(assignId, userIdInt);
                            
                            setTimeout(() => openCollaboratorDocument(assignment.documentId), 500);
                        } else {
                            showAlert('Link inv√°lido ou expirado. Verifique o endere√ßo fornecido.', 'error');
                            loadDocuments();
                        }
                    } catch (error) {
                        showAlert('Erro ao processar link: ' + error.message, 'error');
                        loadDocuments();
                    }
                } else {
                    loadDocuments();
                }
            }, 100);
        }
    </script>

    <!-- Biblioteca SheetJS para exporta√ß√£o Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
</body>
</html>
